$(function () {
    // 生成指定范围内的随机数
    function getRandom(max, min) {
        return max = max || 100, min = min || 0,  // 默认范围为 0-100
            Math.ceil(Math.random() * (max - min) + min)
    }

    // 创建一个带有动画效果的评论，动画结束后自动删除
    function showComment(text) {
        var commentElement = $("<div class='comment'>" + text + "</div>");
        commentElement.on("animationend webkitAnimationEnd", function (event) {
            $(this).remove()
        }).appendTo(bodyElement)
    }

    // 切换显示内容的函数，更改标题和提示文本
    function switchMealTime(timeIndex, forceSwitch) {  // timeIndex: 早饭/午饭/晚饭, forceSwitch: 是否强制切换
        if (!isPlaying) {
            if (currentTimeIndex = timeIndex, 
                timeElement.text(mealOptions[currentTimeIndex][0]), 
                foodNameElement.text("神马"), 
                punctuationElement.text("？"), 
                titleElement.addClass("shake"), 
                clickCount = 0, 
                forceSwitch) {
                var tipElement = $(".tip").show();
                setTimeout(function () {
                    tipElement.remove()
                }, 4e3)
            } 
            // _hmt.push(["_trackEvent", "time", "change", mealOptions[currentTimeIndex][0]])
        }
    }

    // 显示浮动通知的函数
    function showFloatingNotice(message, duration) {
        var notice = $("#floating-notice");
        // 如果元素不存在则创建一个
        if (notice.length === 0) {
            notice = $("<div id='floating-notice'></div>").appendTo("body");
        }
        
        // 设置消息文本并显示
        notice.text(message).addClass("active");
        
        // 设定时间后隐藏提示
        setTimeout(function() {
            notice.removeClass("active");
        }, duration || 2000); // 默认2秒后消失
    }
    
    var isPlaying = 0;                  // 控制切换状态
    var titleElement = $(".title");     // 标题元素
    var timeElement = $(".time");       // 显示时间区域(早饭/午饭/晚饭)
    var foodNameElement = $(".what");   // 显示食物名称
    var punctuationElement = $(".punctuation"); // 显示标点符号
    var startButton = $("#start");      // 开始/停止按钮
    var tempContainer = $("#temp_container"); // 临时元素容器
    var mealOptions = [
        ["早饭", "面包 蛋糕 荷包蛋 烧饼 饽饽 肉夹馍 油条 馄饨 火腿 面条 小笼包 玉米粥 肉包 煎饼果子 饺子 煎蛋 烧卖 生煎 锅贴 包子 酸奶 苹果 梨 香蕉 皮蛋瘦肉粥 蛋挞 南瓜粥 煎饼 玉米糊 泡面 粥 馒头 燕麦片 水煮蛋 米粉 豆浆 牛奶 花卷 豆腐脑 煎饼果子 小米粥 黑米糕 鸡蛋饼 牛奶布丁 水果沙拉 鸡蛋羹 南瓜馅饼 鸡蛋灌饼 奶香小馒头 汉堡包 披萨 八宝粥 三明治 蛋包饭 豆沙红薯饼 驴肉火烧 粥 粢饭糕 蒸饺 白粥".split(" ")],
        ["午饭"],
        ["晚饭", "星光一层咖喱饭 星光一层鸡公煲 星光一层土豆粉 星光一层鸭血粉丝 星光一层广式肠粉 星光一层川香干锅 星光一层锅盔 星光一层麻辣香锅 星光一层汉堡炸鸡 星光一层后厨重地非请勿入 星光一层秦晋面食 星光一层198自选 星光一层重庆麻辣烫 星光一层无名缘米粉 星光一层渔康渔粉 星光一层脆皮鸡 星光一层炸鸡腿 星光一层美味饼屋 星光一层阿婆牛杂 星光一层蜜雪冰城 星光一层瑞幸 星光一层文惠桥 星光一层电脑维修 星光一层早阳包子 星光二层醉美小火锅 星光二层犟哥俩 星光二层豆花饭 星光二层黄焖鸡米饭 星光二层牛伯叔铁锅炖 星光二层小渝府 星光二层斗嘴牛丼饭 星光二层牛肉汤 星光二层麻辣香锅 星光二层东北水饺 原星光二层醉美小火锅 原星光二层大食代 原星光二层云南印象 原星光二层一面之缘 原星光二层公主请吃鱼 原星光二层满口香 原星光二层千百味 原星光二层吃不腻 原星光二层称心如意 星光三层兰州牛肉面 星光三层航语佳烤盘饭 星光三层爱尚韩食 星光三层港式烧腊饭 星光三层亦冰亦火焖锅 星光三层渝悦川菜 星光三层千里香混沌 星光三层瘦show 星光三层铁板厨房 星光三层麻辣烫 星光三层 北苑二层前旗味道 北苑二层崔永元真面 中蓝港式鸡扒饭 中蓝川渝风味 中蓝每粥来特色风味 中蓝福建千里香馄饨 中蓝重庆小面 艺术与传播大楼美食广场全牛匠 艺术与传播大楼美食广场李先生 艺术与传播大楼美食广场天水麻辣烫 艺术与传播大楼美食广场沙县小吃 梆子井餐厅重庆小面 梆子井餐厅羊杂面 梆子井餐厅水煮鱼 梆子井餐厅水饺 梆子井餐厅卤肉饭 梆子井餐厅拉面 梆子井餐厅炒面 梆子井餐厅自选快餐 梆子井餐厅及田家拌饭 梆子井餐厅小表弟海南鸡饭 梆子井餐厅炸鸡汉堡 梆子井餐厅六朝茶泡饭 梆子井餐厅烤鸭 梆子井餐厅黄焖鸡 梆子井餐厅小笼包 梆子井餐厅米粉 梆子井餐厅非请莫入 梆子井餐厅快餐 梆子井餐厅干锅".split(" ")]
    ];
    var nonFoodItems = "冰箱 书桌 电扇 空调 马桶 翔 鼠标 键盘 显示器 电视 台灯 饭盒 iPad iPhone 手机 餐巾纸 电话 椅子 纸箱 窗帘 插座 被单 报纸 杂志 相框 照片 衣服 内裤 内衣 袜子 妹子 汉子 砖头 混凝土 钢筋 塑料袋 衣架 书 手环 手表 鼠标垫 眼药水 跑车 自行车 三轮车 坦克 潜水艇 飞机 火箭 U盘 CPU 显卡 刀片 碎玻璃 圆珠笔 钢笔 交通卡 银行卡 身份证 户口簿 橡皮筋 双面胶 502胶水 订书机 螺丝刀 锤子 榔头 垃圾桶 花花草草 树皮 洗手液 妇炎洁 姨妈巾 哆啦A梦 仙人掌 企鹅 大熊猫 穿山甲 米老鼠 唐老鸭 跳跳虎 旅行箱 DVD 音响 热水器 热水袋 电热棒 电池 充电器 相机 自拍杆 耳机 吊灯 雨伞 钱包 鞋子 人字拖 床垫 绣花针 戒指 窨井盖 路灯 主板 程序猿 工程狮 电线 摄像头 西北风 生活 路由器 洗手液 沐浴露 肥皂 羽毛球拍 保龄球 皮带 皮鞭 电池 牙膏 手电筒 瑜伽垫 假发 82年的自来水 马蜂窝 瑞士军刀 地板 水管 电钻".split(" ");
    var funnyMessages = "大哥，饶命啊大哥 吃吃吃，就知道吃 壮士，干了这碗热翔 就这，还不够我塞牙缝儿 莫慌，抱紧我 吃一个，长一斤 你帅你先吃 你胖你先吃 听说吃这玩意吃不胖 你先吃，我不饿 不吃不是中国人 配上鸡汤，口味更佳 我仿佛看到了盐水瓶 嗯，好吃么？ 饭后注意漱口哦 这菜红烧味道如何？ 饭后百步走，活到九十九 分享页面到朋友圈，可以获得30个QQ太阳 据说吃完99%都哭了 惊天内幕！这网页是逗你玩的 为了身边的朋友！！转！！！！ 我也是醉了 我想静静，不要问我静静是谁 解决吃什么难题哪家强？ 我就笑笑不说话 转发过100，然并卵 活到老，吃到老 我给你讲个笑话 你别哭喔 你知道怎样得精神分裂症吗？那样我就再不是一个人了。 天下没有不散的筵席。我都还没吃完，你们都走了。 吃不到的醋，最酸。 躲了一辈子的雨，雨会不会很难过 小猪一定不知道自己的肉很好吃吧，真替它们心酸。 作为一个胖子，居然还自称自己不是个粗人！ 心情不好就吃吃吃 念念不忘，必会下单 好吃不如饺子，好玩不过嫂子 别低头，哈喇子会掉 今晚我们都是吃货 我这叫圆润，不叫胖 这不叫胖，叫丰满！ 吃饭前记得用手机消消毒 集满20个赞，明天早起瘦10斤 好吃的不要不要的 不好吃，不要钱 吃的我蹲下起立就头晕 听说你是广东人？ 贝爷，卒。".split(" ");
    var currentTimeIndex = 2;
    var currentHour = (new Date).getHours();
    var windowObj = $(window);
    var bodyElement = $("body");
    var wrapperElement = $("#wrapper");
    var outputElement = $(".os");
    var clickCount = 0;
    var currentMode = "human";
    var animationTimer;
    var windowWidth, windowHeight;

    // 将午饭的食物列表设置为与晚饭相同
    mealOptions[1][1] = mealOptions[2][1];
    
    // 为标题元素添加动画结束事件监听，移除shake类
    titleElement.on("animationend webkitAnimationEnd", function (event) {
        $(this).removeClass("shake")
    }); 
    
    // 为临时容器添加动画结束事件，移除动画完成的元素
    tempContainer.on("animationend webkitAnimationEnd", function (event) {
        $(event.target).remove()
    }); 
    
    // 点击开始/停止按钮事件处理
    startButton.click(function () {
        if (bodyElement.toggleClass("playing", !isPlaying), isPlaying) {
            // 如果当前是播放状态，停止播放
            isPlaying = 0;
            if (currentMode == "monster") {
                outputElement.text(funnyMessages[getRandom(funnyMessages.length)]);
            }
            punctuationElement.text("！"); 
            startButton.find("span").text("换一个"); 
            clearTimeout(animationTimer);
            document.title = "小明の雜貨鋪｜" + titleElement.text() + "這是一個很無聊的網站，但能解決你的人生一大困擾！選擇困難戶必備！";
        } else {
            // 如果当前是停止状态，开始播放
            isPlaying = 1;
            clickCount++;
            // 根据点击次数显示不同的调侃文本
            if (clickCount == 2) showComment("我就知道你會換一個 ( ͡° ͜ʖ ͡°)");
            if (clickCount == 5) showComment("說，你是不是天秤座？Σ( ° △ °|||)︴");
            if (clickCount == 10) showComment("你是吃了炫邁嗎？(￣△￣；)");
            if (clickCount == 20) showComment("難道你是處女座？ (๑•̀ㅂ•́)و✧");
            if (clickCount == 30) showComment("再換我可要報警了！( *・ω・)✄╰ひ╯");
            
            // 根据当前模式选择数据源
            var itemList = (currentMode == "human") ? mealOptions[currentTimeIndex][1] : nonFoodItems;
            
            // 更新界面元素状态
            punctuationElement.text("？");
            startButton.find("span").text("停"); 
            outputElement.text("");
            
            // 定义并立即执行随机显示选项的函数
            function showRandomItems() {
                var randomIndex = getRandom(itemList.length) - 1;
                var selectedItem = itemList[randomIndex]; 
                var randomTop = getRandom(window.innerHeight);
                var randomLeft = getRandom(window.innerWidth - 50);
                var randomFontSize = getRandom(37, 14);
                
                // 设置显示文本和样式
                foodNameElement.text(selectedItem).css({
                    'white-space': 'normal',  
                    'overflow': 'visible',
                    'text-overflow': 'clip',
                    'display': 'inline-block',
                    'max-width': 'none'
                });
                
                // 创建一个临时元素，显示在随机位置
                var tempElement = $("<span class='temp'>" + selectedItem + "</span>").css({
                    top: randomTop, 
                    left: randomLeft, 
                    color: "rgba(0,0,0," + getRandom(7, 3) / 10 + ")", 
                    fontSize: randomFontSize + "px"
                }).appendTo(tempContainer);
                
                // 设置定时器继续随机显示
                animationTimer = setTimeout(showRandomItems, 60);
            }
            
            // 立即执行随机显示函数
            showRandomItems();
        }
    });
    
    // 文档加载完成后的事件处理
    $(document).ready(function() {
        $(".title").off('click').on('click', function() {
            switchMealTime(currentTimeIndex >= mealOptions.length - 1 ? 0 : currentTimeIndex + 1);
            // showFloatingNotice("切换为" + mealOptions[(currentTimeIndex >= mealOptions.length - 1 ? 0 : currentTimeIndex + 1)][0] + "!", 1500);
        });
    });
    
    // 模式切换事件处理
    $('#toggle-human, #toggle-monster').change(function() {
        currentMode = this.value;
        
        // 根据模式显示不同的提示信息
        if (currentMode === 'monster') {
            showFloatingNotice("註意！前方高能！");
        } else {
            showFloatingNotice("還是人類好吃呢Ψ(￣∀￣)Ψ");
        }
        
        clickCount = 0; // 重置计数器
        // _hmt.push(["_trackEvent", "type", "toggle", currentMode]); 
    });
    
    // 根据当前时间自动选择早饭或午饭
    if (currentHour < 9 || currentHour >= 23) {
        switchMealTime(0, 1);
    } else if (currentHour < 13) {
        switchMealTime(1, 1);
    }
    
    // 点击标题切换时间段
    titleElement.click(function () {
        switchMealTime(currentTimeIndex >= mealOptions.length - 1 ? 0 : currentTimeIndex + 1);
    });
    
    // 点击彩带显示标题
    $("#ribbon").click(function () {
        return alert(this.title), false;
    });
    
    // 窗口大小改变时更新尺寸变量
    windowObj.resize(function () {
        windowWidth = windowObj.width();
        windowHeight = windowObj.height();
    }).resize(); // 立即执行一次resize
});