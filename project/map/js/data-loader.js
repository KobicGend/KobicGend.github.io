import{provinceMap}from"./map-config.js";export class DataLoader{constructor(){this.cityIndex={},this.chinaJson=null,this.pointData=null,this.fullData=null}async init(){const[t,a]=await Promise.all([fetch("/project/map/data.csv").then(t=>t.text()),fetch("/project/map/json/china.json").then(t=>t.json())]),n=parseCsv(t);this.chinaJson=a,await Promise.all(Object.entries(provinceMap).map(async([t,a])=>{try{const n=await fetch(`/project/map/json/province/${a}.json`);if(!n.ok)return;const{features:r}=await n.json();if(Array.isArray(r))for(const{properties:a}of r){const{name:n,center:r}=a;n&&r&&(this.cityIndex[n]={province:t,coord:r})}}catch(a){console.warn(`⚠️ 加载省份 ${t} 数据失败:`,a)}})),this.pointData=enrichDataWithCoords(n,this.cityIndex);const r=getCounts(this.pointData,"province"),o=getCounts(this.pointData,"city");return this.fullData=[...r,...o],{chinaJson:this.chinaJson,pointData:this.pointData,fullData:this.fullData}}}function enrichDataWithCoords(t,a){return t.map(t=>{const n=t.city,r=a[n];return r?{...t,province:r.province,value:t.coord||r.coord}:(console.warn(`⚠️ 无法识别城市: ${n}`),t)})}function getCounts(t,a){const n={};return t.forEach(t=>{if("city"===a&&["北京市","上海市","天津市","重庆市"].includes(t.province))return;const r="city"===a?t.city:t.province;r?(n[r]||(n[r]={value:0,records:[]}),n[r].value+=1,n[r].records.push(t)):console.warn(`⚠️ 无法识别 ${a}:`,t)}),Object.keys(n).map(t=>({name:t,value:n[t].value,records:n[t].records.sort((t,a)=>new Date(a.date)-new Date(t.date))}))}function parseCsv(t){if(!window.Papa)throw new Error("PapaParse 未加载");const a=window.Papa.parse(t,{header:!0,skipEmptyLines:!0,transform:t=>"string"==typeof t?t.trim():t});return a.errors&&a.errors.length&&console.warn("⚠️ CSV 解析错误:",a.errors),Array.isArray(a.data)?a.data:[]}