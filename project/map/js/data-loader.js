import{provinceMap}from"./map-config.js";export class DataLoader{constructor(){this.cityIndex={},this.chinaJson=null,this.pointData=null,this.fullData=null}async init(){const[t,n]=await Promise.all([fetch("/project/map/data.csv").then(t=>t.text()),fetch("/project/map/json/china.json").then(t=>t.json())]),e=parseCsv(t);this.chinaJson=n,await Promise.all(Object.entries(provinceMap).map(async([t,n])=>{try{const e=await fetch(`/project/map/json/province/${n}.json`);if(!e.ok)return;const{features:o}=await e.json();if(Array.isArray(o))for(const{properties:n}of o){const{name:e,center:o}=n;e&&o&&(this.cityIndex[e]={province:t,coord:o})}}catch(n){console.warn(`⚠️ 加载省份 ${t} 数据失败:`,n)}})),this.pointData=enrichDataWithCoords(e,this.cityIndex);const o=getCounts(this.pointData,"province"),r=getCounts(this.pointData,"city");return this.fullData=[...o,...r],{chinaJson:this.chinaJson,pointData:this.pointData,fullData:this.fullData}}}function enrichDataWithCoords(t,n){return t.map(t=>{const e=t.city,o=n[e];return o?{...t,province:o.province,value:t.coord||o.coord}:(console.warn(`⚠️ 无法识别城市: ${e}`),t)})}function getCounts(t,n){const e={};return t.forEach(t=>{if("city"===n&&["北京市","上海市","天津市","重庆市"].includes(t.province))return;const o="city"===n?t.city:t.province;o?(e[o]||(e[o]={value:0,records:[]}),e[o].value+=1,e[o].records.push(t)):console.warn(`⚠️ 无法识别 ${n}:`,t)}),Object.keys(e).map(t=>({name:t,value:e[t].value,records:e[t].records.sort((t,n)=>new Date(n.date)-new Date(t.date))}))}function parseCsv(t){if(!t)return[];try{let n=t.replace(/^\uFEFF/,"");const e=[];let o=[],r="",a=!1;n=n.replace(/\r\n/g,"\n").replace(/\r/g,"\n");for(let t=0;t<n.length;t++){const s=n[t],c=n[t+1];a?'"'===s&&'"'===c?(r+='"',t++):'"'===s?a=!1:r+=s:'"'===s?a=!0:","===s?(o.push(r.trim()),r=""):"\n"===s?(o.push(r.trim()),o.some(t=>""!==t)&&e.push(o),o=[],r=""):r+=s}if((r||o.length>0)&&(o.push(r.trim()),o.some(t=>""!==t)&&e.push(o)),0===e.length)return[];const s=e.shift().map(t=>t.trim());return e.map(t=>{const n={};return s.forEach((e,o)=>{n[e]=void 0!==t[o]?t[o]:""}),n})}catch(t){return console.error("⚠️ CSV 解析失败:",t.message),[]}}