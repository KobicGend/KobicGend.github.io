import{provinceMap}from"./map-config.js";import{getChartOption}from"./map-core.js";import{UIManager}from"./ui-manager.js";export class MapController{constructor(t,e){this.chart=echarts.init(document.getElementById(t)),this.data=e,this.currentLevel="china",this.initEvents()}renderChina(){this.currentLevel="china",echarts.registerMap("china",this.data.chinaJson);const t=getChartOption("china",this.data.pointData,this.data.fullData,{});UIManager.createTitleBar("足跡"),this.chart.setOption(t,!0)}async drillDown(t){if("effectScatter"===t.seriesType)return void(t.data?.url&&window.open(t.data.url,"_blank"));const e=t.name,r=provinceMap[e];if(r)try{const t=this.chart.getOption(),a=await fetch(`/project/map/json/province/${r}.json`).then(t=>t.json()),i=stitchMap(this.data.chinaJson,a,e),n=`mixed-${r}`;echarts.registerMap(n,i);const o=getChartOption(n,this.data.pointData,this.data.fullData,{center:t.geo[0].center,zoom:t.geo[0].zoom,cityNames:a.features.map(t=>t.properties.name),activeProvinceName:e,isProvinceLevel:!0});UIManager.createTitleBar(`足跡·${e}`),this.chart.setOption(o,!0),this.currentLevel="province"}catch(t){console.error("下钻失败:",t)}}exitProvinceKeepView(){if("province"!==this.currentLevel)return;const t=this.chart.getOption(),e=t.geo[0].zoom,r=t.geo[0].center;this.currentLevel="china";const a=getChartOption("china",this.data.pointData,this.data.fullData,{center:r,zoom:e});UIManager.createTitleBar("足跡"),this.chart.setOption(a,!0)}initEvents(){this.chart.on("click",t=>this.drillDown(t)),this.chart.getZr().on("contextmenu",t=>{t.event.preventDefault(),"province"===this.currentLevel&&this.exitProvinceKeepView()}),window.addEventListener("resize",()=>this.chart.resize())}}export function stitchMap(t,e,r){const a=t.features.filter(t=>t.properties.name!==r),i=JSON.parse(JSON.stringify(t.features.find(t=>t.properties.name===r)));return i.properties.name=r+"_BORDERS",{type:"FeatureCollection",features:[...a,...e.features,i]}}