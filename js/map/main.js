import{getCounts,enrichDataWithCoords}from"./map-utils.js";import{provinceMap}from"./map-config.js";import{stitchMap,getChartOption}from"./map-core.js";const chart=echarts.init(document.getElementById("footprint"));let currentLevel="china",globalChinaJson=null;async function main(){try{console.log("ğŸš€ æ­£åœ¨æ„å»ºå…¨å±€åŸå¸‚ç´¢å¼•...");const[e,t]=await Promise.all([fetch("/json/map/pointData.json").then(e=>e.json()),fetch("/json/map/chinaJson.json").then(e=>e.json())]),n=Object.values(provinceMap),o=await Promise.all(n.map(e=>fetch(`/json/map/province/${e}.json`).then(e=>e.json()).catch(()=>null))),r={};o.forEach((e,t)=>{if(!e)return;const o=Object.keys(provinceMap).find(e=>provinceMap[e]===n[t]);e.features.forEach(e=>{const t=e.properties.name,n=e.properties.center||e.properties.cp;t&&n&&(r[t]={province:o,coord:n})})});const c=enrichDataWithCoords(e,r);globalChinaJson=t;const a=getCounts(c,"province"),i=getCounts(c,"city"),s=[...a,...i];echarts.registerMap("china",t);const p=getChartOption("china",c,s);chart.setOption(p);const l=document.getElementById("footprint").parentElement;l.style.position="relative";const h=document.createElement("button");h.innerHTML="ğŸ  é‡ç½®è§†è§’",Object.assign(h.style,{position:"absolute",top:"30px",right:"30px",zIndex:"100",padding:"10px 18px",background:"#fff",border:"1px solid #171a24",borderRadius:"4px",cursor:"pointer",fontFamily:"serif",fontWeight:"bold",boxShadow:"0 4px 12px rgba(0,0,0,0.15)"}),l.appendChild(h),h.addEventListener("click",()=>{console.log("ğŸ”„ æ‰§è¡Œé‡ç½®ï¼šè¿”å›å…¨å›½è§†è§’"),currentLevel="china";const e=getChartOption("china",c,a,{title:"æˆ‘çš„è¶³è¿¹åœ°å›¾",isProvinceLevel:!1});chart.setOption(e,!0)}),chart.on("click",async e=>{if("effectScatter"!==e.seriesType){const t=e.name,n=provinceMap[t];if(n)try{const o=chart.getOption(),r=o.geo[0].zoom,a=o.geo[0].center,i=await fetch(`/json/map/province/${n}.json`).then(e=>e.json()),p=stitchMap(globalChinaJson,i,e.name),l=`mixed-${n}`;echarts.registerMap(l,p);const h=i.features.map(e=>e.properties.name),m=getChartOption(l,c,s,{center:a,zoom:r,cityNames:h,activeProvinceName:t,title:`${e.name}Â·æ­¥å±¥ä¸åœ`,isProvinceLevel:!0});chart.setOption(m,!0),currentLevel="province"}catch(e){console.error("âŒ åŠ è½½æˆ–æ¸²æŸ“å¤±è´¥:",e),alert(`åŠ è½½ /json/map/province/${n}.json å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨`)}else console.warn(`âš ï¸ å­—å…¸é‡Œæ²¡æ‰¾åˆ° [${t}]ï¼Œè¯·æ£€æŸ¥ map-config.js`)}else e.data?.url&&window.open(e.data.url,"_blank")}),document.getElementById("footprint").addEventListener("contextmenu",e=>{if(e.preventDefault(),"province"===currentLevel){const e=chart.getOption(),t=e.geo[0].zoom,n=e.geo[0].center;currentLevel="china";const o=getChartOption("china",c,s,{center:n,zoom:t});chart.setOption(o,!0)}}),window.addEventListener("resize",()=>chart.resize())}catch(e){console.error("âŒ åˆå§‹åŒ–æŠ¥é”™:",e)}}main(),document.getElementById("reset-view-btn").addEventListener("click",()=>{console.log("ğŸ”„ é‡ç½®è§†è§’ï¼šè¿”å›å…¨å›½åœ°å›¾"),currentLevel="china";const e=getChartOption("china",pointData,provinceData,{title:"æˆ‘çš„è¶³è¿¹åœ°å›¾"});chart.setOption(e,!0);const t=document.getElementById("map-title");t&&(t.innerText="æˆ‘çš„è¶³è¿¹åœ°å›¾")});