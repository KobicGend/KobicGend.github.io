import{provinceMap}from"./map-config.js";export class DataLoader{constructor(){this.cityIndex={},this.chinaJson=null,this.pointData=null,this.fullData=null}async init(){const[t,n]=await Promise.all([fetch("/json/map/pointData.json").then(t=>t.json()),fetch("/json/map/chinaJson.json").then(t=>t.json())]);this.chinaJson=n,await Promise.all(Object.entries(provinceMap).map(async([t,n])=>{try{const o=await fetch(`/json/map/province/${n}.json`);if(!o.ok)return;const{features:a}=await o.json();if(Array.isArray(a))for(const{properties:n}of a){const{name:o,center:a}=n;o&&a&&(this.cityIndex[o]={province:t,coord:a})}}catch(n){console.warn(`⚠️ 加载省份 ${t} 数据失败:`,n)}})),this.pointData=enrichDataWithCoords(t,this.cityIndex);const o=getCounts(this.pointData,"province"),a=getCounts(this.pointData,"city");return this.fullData=[...o,...a],{chinaJson:this.chinaJson,pointData:this.pointData,fullData:this.fullData}}}function enrichDataWithCoords(t,n){return t.map(t=>{const o=t.city,a=n[o];return a?{...t,province:a.province,value:t.coord||a.coord}:(console.warn(`⚠️ 无法识别城市: ${o}`),t)})}function getCounts(t,n){const o={};return t.forEach(t=>{if("city"===n&&["北京市","上海市","天津市","重庆市"].includes(t.province))return;const a="city"===n?t.city:t.province;a?(o[a]||(o[a]={value:0,records:[]}),o[a].value+=1,o[a].records.push(t)):console.warn(`⚠️ 无法识别 ${n}:`,t)}),Object.keys(o).map(t=>({name:t,value:o[t].value,records:o[t].records.sort((t,n)=>new Date(n.date)-new Date(t.date))}))}